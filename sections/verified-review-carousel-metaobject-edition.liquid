<div class="verified-review-section">
  <div class="container">
    <div class="section-title">
      <h2>
        {{ section.settings.section_title }}
      </h2>

      <div class="section-subtitle">
        {{ section.settings.section_subtitle }}
      </div>
    </div>

    <div class="testimonials-carousel">
      <div class="testimonials-track" id="testimonials-track-{{ section.id }}">

      {% assign testimonials = section.settings.review_metaobject %}

          {% assign reviews = testimonials.customers_reviews_data %}

            {% for review in reviews %}
              <div class="testimonial-card {% if section.settings.card_zoom %}zoom-enabled{% endif %}" data-index="{{ forloop.index0 }}">

                {% if review.image %}
                  <img
                    src="{{ review.image | image_url: width: 1000 }}"
                    alt="{{ review.customer_name | escape }}"
                    loading="lazy"
                  >
                {% else %}
                  <img
                    src="{{ 'placeholder.webp' | asset_url }}"
                    alt="Customer"
                    loading="lazy"
                  >
                {% endif %}

                <div class="author-stars">
                  {% assign max = 5 %}
                  {% assign filled = review.customer_rating.value | default: 5 %}
                  {% assign empty = max | minus: filled %}
                  {% for i in (1..filled) %}★{% endfor %}
                  {% for i in (1..empty) %}☆{% endfor %}
                </div>

                <div class="testimonial-author">
                  <div class="author-info">
                    <div class="author-name">
                      {{ review.customer_name.value }}
                      {% if review.customer_age %}
                        , {{ review.customer_age }}
                      {% endif %}
                    </div>
                    <div class="author-verified">
                      ✔ Verified Customer
                    </div>
                  </div>
                </div>

                {% if review.customer_heading %}
                  <h3 class="testimonial-title">
                    {{ review.customer_heading.value | strip_html }}
                  </h3>
                {% endif %}

                {% if review.customer_review %}
                  <p class="testimonial-content">
                    {{ review.customer_review }}
                  </p>
                {% endif %}

              </div>
            {% endfor %}


    </div>
</div>
  

    <div class="carousel-controls">
      <button class="carousel-button" id="prev-btn-{{ section.id }}" type="button" aria-label="Previous testimonial">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      
      <div class="carousel-dots" id="carousel-dots-{{ section.id }}"></div>
      
      <button class="carousel-button" id="next-btn-{{ section.id }}" type="button" aria-label="Next testimonial" >
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    </div>
  </div>
</div>

{% style %}
  .verified-review-section {
    background: {{ section.settings.section_background }};
  }
  .container {
    display: flex;
    flex-direction: column;
    justify-self: center;
    padding: 40px;
  }

  .section-title {
    text-align: center;
    margin-bottom: 40px;
  }

  .section-title h2 {
    font-family: 'Albert Sans', sans-serif; 
    font-weight: medium;
    text-transform: none;
    letter-spacing: 1px;
    margin: 0 0 15px 0;
    color: {{ section.settings.title_color }} !important; 
    font-size: {{ section.settings.title_size }}px !important;
  }

  .section-title .section-subtitle{
    color: {{ section.settings.subtitle_color }}; 
    font-size: {{ section.settings.subtitle_size }}px;
  }

  .stars {
    color: #ffa500;
    font-size: 18px;
  }

  .rating-text {
    font-size: 18px;
    color: white;
  }

  .testimonials-carousel {
    position: relative;
    overflow: hidden;
    margin-bottom: 40px;
    width: 1200px;
    padding: 20px 0;
    overflow-y: auto;
    min-height: auto  ;
    max-height: 800px;
    align-content: center;
  }

  .testimonials-track {
    display: flex;
    transition: transform 0.5s ease;
    gap: 20px;
  }

  .testimonial-card {
    flex: 0 0 calc((100% - 50px) / 3);
    min-width: 280px;
    height: auto;
    padding: 20px 24px;
    border-radius: 12px;
    text-align: left;
    box-sizing: border-box;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    border: 1px solid #EDE9F5;
    background-color: {{ section.settings.card_color }};
  }
  
  .testimonial-card img{
    border-radius: 12px;
    width: 335px;
    height: 350px;
    object-fit: cover;
  }

  .testimonial-card.active {
    background-color:{{ section.settings.card_active_color }};
  }

  .testimonial-card.zoom-enabled.active {
    transform: scale(1.05);
  }

  .testimonial-title {
    color: {{ section.settings.testimonial_title_color }};
    font-size: {{ section.settings.testimonial_title_size }}px;
    font-weight: 600;
    margin: 0 0 12px 0;
    text-transform: normal;
    line-height: 1.2;
  }

  .testimonial-content {
    line-height: 1.5;
    margin: 0 0 auto 0;
    flex-grow: 1;
    overflow: hidden;
    color: {{ section.settings.testimonial_content_color }}; 
    font-size: {{ section.settings.testimonial_content_size }}px;
  }

  .testimonial-author {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 16px;
    margin-bottom: 16px;
    min-height: 40px;
  }

  .author-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: #555;
    overflow: hidden;
    flex-shrink: 0;
  }

  .author-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .author-info {
    flex: 1;
    min-width: 0;
    overflow: hidden;
    display: flex;
    justify-content: space-between;
  }

  .author-name {
    color: {{ section.settings.testimonial_author_color }};
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: {{ section.settings.testimonial_author_size }}px;
  }

  .author-verified {
    font-size: 14px;
    color: {{ section.settings.badge_color }};
    display: flex;
    align-items: center;
    gap: 3px;
    white-space: nowrap;
  }

  .author-verified circle {
    fill: {{ section.settings.badge_color }};
  }

  .author-stars {
    padding-top: 16px;
    color: {{ section.settings.testimonial_star_color }};
    font-size: 24px;
    flex-shrink: 0;
    margin-left: 4px;
  }

  .carousel-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
  }

  .carousel-button {
    background-color:{{ section.settings.button_color }};
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s;
    flex-shrink: 0;
  }

  .carousel-button:hover {
    background-color: #5a7b8c;
  }

  .carousel-dots {
    display: flex;
    gap: 10px;
  }

  .carousel-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #dedbe1;
    cursor: pointer;
    border: none;
    padding: 0;
    transition: background-color 0.3s;
  }

  .carousel-dot.active {
    background-color: {{ section.settings.button_color }};
  }

  @media (max-width: 968px) {
    .testimonial-card {
      flex: 0 0 calc((100% - 20px) / 2);
    }

    .testimonial-card img {
      width: 257px !important;
      height: 286px !important;
      object-fit: cover;
    }
  }

  @media (max-width: 640px) {
    .section-title h2 {
      font-size: 28px;
    }
    
    .testimonials-carousel {
      width: 430px;
      margin-bottom: 30px;
      padding: 20px 10px;
    }
    
    .testimonials-track {
      gap: 15px;
    }
    
    .testimonial-card {
      flex: 0 0 auto;
      width: calc(100vw - 60px);
      min-width: unset;
      padding: 16px 20px;
    }
    
    .testimonial-title {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .testimonial-content {
      font-size: 14px;
      line-height: 1.4;
    }
    
    .carousel-controls {
      gap: 12px;
    }
    
    .carousel-button {
      width: 36px;
      height: 36px;
    }
    
    .carousel-button svg {
      width: 16px;
      height: 16px;
    }
  }

  @media (max-width: 480px) {
    .verified-review-section .container {
      max-width: 470px;
    }
    .testimonial-card {
      max-width: 300px;
    }
    .section-title h2 {
      font-size: 28px;
      max-width: 300px !important;
      justify-self: center !important;
    }

  }
{% endstyle %}

<script>
  (function() {
    const sectionId = '{{ section.id }}';
    const track = document.getElementById('testimonials-track-' + sectionId);
    const prevBtn = document.getElementById('prev-btn-' + sectionId);
    const nextBtn = document.getElementById('next-btn-' + sectionId);
    const dotsContainer = document.getElementById('carousel-dots-' + sectionId);
    
    if (!track || !prevBtn || !nextBtn || !dotsContainer) {
      console.error('Testimonials carousel elements not found for section:', sectionId);
      return;
    }
    
    const originalCards = Array.from(track.querySelectorAll('.testimonial-card'));
    
    // Only initialize carousel if there are cards
    if (originalCards.length === 0) {
      return;
    }

    if (originalCards.length <= 3) {
      // Hide controls if 3 or fewer cards
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      dotsContainer.style.display = 'none';
      return;
    }
    
    const totalCards = originalCards.length;
    let currentIndex = 0;
    let isTransitioning = false;
    
    // Clone cards for infinite effect
    function setupInfiniteCarousel() {
      // Clone all cards and append to the end
      originalCards.forEach(card => {
        const clone = card.cloneNode(true);
        track.appendChild(clone);
      });
      
      // Clone all cards and prepend to the beginning
      for (let i = originalCards.length - 1; i >= 0; i--) {
        const clone = originalCards[i].cloneNode(true);
        track.insertBefore(clone, track.firstChild);
      }
      
      // Set initial position to show the first set of original cards
      currentIndex = totalCards;
      updateCarousel(false);
    }

    function createDots() {
      dotsContainer.innerHTML = '';
      for (let i = 0; i < totalCards; i++) {
        const dot = document.createElement('button');
        dot.classList.add('carousel-dot');
        dot.setAttribute('aria-label', `Go to slide ${i + 1}`);
        if (i === 0) dot.classList.add('active');
        dot.addEventListener('click', () => goToSlide(i));
        dotsContainer.appendChild(dot);
      }
    }

    function updateCarousel(animate = true) {
      const allCards = track.querySelectorAll('.testimonial-card');
      const cardWidth = allCards[0].offsetWidth;
      const style = window.getComputedStyle(track);
      const gap = parseInt(style.columnGap || style.gap || 20);
      //const offset = currentIndex * (cardWidth + gap);
      
      // Calculate offset with centering for mobile
      let offset = currentIndex * (cardWidth + gap);
      
      // Center the card on mobile screens
      if (window.innerWidth <= 480) {
        const carouselWidth = track.parentElement.offsetWidth;
        const centerOffset = (carouselWidth - cardWidth) / 4;
        offset = offset - centerOffset;
      }

      if (!animate) {
        track.style.transition = 'none';
      } else {
        track.style.transition = 'transform 0.5s ease';
      }
      
      track.style.transform = `translateX(-${offset}px)`;
      
      updateDots();
      updateActiveCard();
      
      if (!animate) {
        // Force reflow
        track.offsetHeight;
        track.style.transition = 'transform 0.5s ease';
      }
    }

    function updateDots() {
      const dots = dotsContainer.querySelectorAll('.carousel-dot');
      const actualIndex = ((currentIndex - totalCards) % totalCards + totalCards) % totalCards;
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === actualIndex);
      });
    }

    function updateActiveCard() {
      const allCards = track.querySelectorAll('.testimonial-card');
      const windowWidth = window.innerWidth;
      
      // Determine which card should be active based on screen size
      let activeCardIndex;
      if (windowWidth <= 640) {
        // Mobile: highlight the current card
        activeCardIndex = currentIndex;
      } else if (windowWidth <= 968) {
        // Tablet: highlight the first card (left card of 2)
        activeCardIndex = currentIndex;
      } else {
        // Desktop: highlight the middle card (center of 3)
        activeCardIndex = currentIndex + 1;
      }
      
      allCards.forEach((card, index) => {
        card.classList.toggle('active', index === activeCardIndex);
      });
    }

    function goToSlide(slideIndex) {
      if (isTransitioning) return;
      currentIndex = totalCards + slideIndex;
      updateCarousel();
    }

    function handleTransitionEnd() {
      isTransitioning = false;
      
      // If we're past the end, jump back to the start position
      if (currentIndex >= totalCards * 2) {
        currentIndex = totalCards;
        updateCarousel(false);
      }
      
      // If we're before the start, jump to the end position
      if (currentIndex < totalCards) {
        currentIndex = totalCards * 2 - 1;
        updateCarousel(false);
      }
    }

    prevBtn.addEventListener('click', () => {
      if (isTransitioning) return;
      isTransitioning = true;
      currentIndex--;
      updateCarousel();
    });

    nextBtn.addEventListener('click', () => {
      if (isTransitioning) return;
      isTransitioning = true;
      currentIndex++;
      updateCarousel();
    });

    track.addEventListener('transitionend', handleTransitionEnd);

    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        updateCarousel(false);
      }, 250);
    });

    setupInfiniteCarousel();
    createDots();
  })();
</script>

{% schema %}
{
  "name": "Reviews Carousel (Meta)",
  "settings": [
    {
      "type": "metaobject",
      "id": "review_metaobject",
      "label": "Select Metaobject",
      "metaobject_type": "testimonials"
    }
  ],
  "presets": [
    {
      "name": "Reviews Carousel (Meta)",
    }
  ]
}
{% endschema %}

<div class="verified-review-section">
  <div class="verified-container">
    <div class="verified-header">
      <h2 class="verified-title">{{ section.settings.section_title }}</h2>
      <p class="verified-subtitle">{{ section.settings.section_subtitle }}</p>
    </div>

    <div class="testimonials-carousel">
      <div class="testimonials-track" id="testimonials-track-{{ section.id }}">
        
        {% assign reviews = section.settings.reviews.value %}
        {% if reviews %}
          {% for review in reviews %}
            <div class="testimonial-card {% if section.settings.card_zoom %}zoom-enabled{% endif %}" data-index="{{ forloop.index0 }}">

              {% if review.image %}
                <img
                  src="{{ review.image | image_url: width: 1000 }}"
                  alt="{{ review.customer_name | default: 'Customer' }}"
                  loading="lazy"
                  style="object-position: {{ review.image_position | default: 'center' }};"
                >
              {% else %}
                <img
                  src="{{ 'placeholder.webp' | asset_url }}"
                  alt="{{ review.customer_name | default: 'Customer' }}"
                  loading="lazy"
                >
              {% endif %}
              
              <div class="author-stars">
                {% assign max = 5 %}
                {% assign filled = review.rating | default: 5 %}
                {% assign empty = max | minus: filled %}

                {% for i in (1..filled) %}★{% endfor %}
                {% for i in (1..empty) %}☆{% endfor %}
              </div>

              <div class="testimonial-author">
                <div class="author-info">
                  <div class="author-name">
                    {{ review.customer_name }}
                    {% if review.customer_age %}
                      , {{ review.customer_age }}
                    {% endif %}
                  </div>
                  <div class="author-verified">
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      xmlns="http://www.w3.org/2000/svg"
                      style="margin-right:4px;"
                    >
                      <circle cx="12" cy="12" r="12" />
                      <path
                        d="M9.5 13.8L6.7 11L5.3 12.4L9.5 16.6L18.7 7.4L17.3 6L9.5 13.8Z"
                        fill="#ffffff"
                      />
                    </svg>
                    Verified Customer
                  </div>
                </div>
              </div>

              {% if review.heading %}
                <h3 class="testimonial-title">{{ review.heading | strip_html }}</h3>
              {% endif %}

              {% if review.review_text %}
                <p class="testimonial-content">{{ review.review_text | truncate: 340 }}</p>
              {% endif %}

            </div>
          {% endfor %}
        {% endif %}

      </div>
    </div>  

    <div class="carousel-controls">
      <button class="carousel-button" id="prev-btn-{{ section.id }}" type="button" aria-label="Previous testimonial">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      
      <div class="carousel-dots" id="carousel-dots-{{ section.id }}"></div>
      
      <button class="carousel-button" id="next-btn-{{ section.id }}" type="button" aria-label="Next testimonial">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    </div>
  </div>
</div>

{% style %}
  /* ============================================
     Section Background
     ============================================ */

  .verified-review-section {
    background: {{ section.settings.section_background }};
    padding: 60px 20px;
  }

  /* ============================================
     Container
     ============================================ */

  .verified-container {
    max-width: 1280px;
    margin: 0 auto;
  }

  /* ============================================
     Header
     ============================================ */

  .verified-header {
    text-align: center;
    margin-bottom: 50px;
  }

  .verified-title {
    font-family: 'Albert Sans', sans-serif; 
    font-weight: 500;
    letter-spacing: 0.5px;
    margin: 0 0 15px;
    color: {{ section.settings.title_color }}; 
    font-size: {{ section.settings.title_size }}px;
    line-height: 1.2;
  }

  .verified-subtitle {
    color: {{ section.settings.subtitle_color }}; 
    font-size: {{ section.settings.subtitle_size }}px;
    margin: 0;
    line-height: 1.5;
  }

  /* ============================================
     Carousel
     ============================================ */

  .testimonials-carousel {
    position: relative;
    overflow: hidden;
    margin-bottom: 40px;
    padding: 20px 0;
  }

  .testimonials-track {
    display: flex;
    transition: transform 0.5s ease;
    gap: 20px;
  }

  /* ============================================
     Testimonial Cards
     ============================================ */

  .testimonial-card {
    flex: 0 0 calc((100% - 40px) / 3);
    min-width: 280px;
    padding: 20px 24px;
    border-radius: 12px;
    border: 1px solid #EDE9F5;
    background-color: {{ section.settings.card_color }};
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
  }
  
  .testimonial-card img {
    border-radius: 12px;
    width: 100%;
    height: 350px;
    object-fit: cover;
    margin-bottom: 16px;
  }

  .testimonial-card.active {
    background-color: {{ section.settings.card_active_color }};
  }

  .testimonial-card.zoom-enabled.active {
    transform: scale(1.05);
  }

  /* Stars */
  .author-stars {
    padding-top: 16px;
    padding-bottom: 8px;
    color: {{ section.settings.testimonial_star_color }};
    font-size: 24px;
  }

  /* Author Info */
  .testimonial-author {
    display: flex;
    align-items: center;
    margin-bottom: 16px;
    min-height: 40px;
  }

  .author-info {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
  }

  .author-name {
    color: {{ section.settings.testimonial_author_color }};
    font-size: {{ section.settings.testimonial_author_size }}px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .author-verified {
    font-size: 14px;
    color: {{ section.settings.badge_color }};
    display: flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .author-verified circle {
    fill: {{ section.settings.badge_color }};
  }

  /* Review Content */
  .testimonial-title {
    color: {{ section.settings.testimonial_title_color }};
    font-size: {{ section.settings.testimonial_title_size }}px;
    font-weight: 600;
    margin: 0 0 12px;
    line-height: 1.3;
  }

  .testimonial-content {
    color: {{ section.settings.testimonial_content_color }}; 
    font-size: {{ section.settings.testimonial_content_size }}px;
    line-height: 1.6;
    margin: 0;
    flex-grow: 1;
  }

  /* ============================================
     Carousel Controls
     ============================================ */

  .carousel-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
  }

  .carousel-button {
    background-color: {{ section.settings.button_color }};
    border: none;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    flex-shrink: 0;
  }

  .carousel-button:hover {
    background-color: #4a5f6e;
    transform: scale(1.1);
  }

  .carousel-button:active {
    transform: scale(0.95);
  }

  .carousel-dots {
    display: flex;
    gap: 8px;
  }

  .carousel-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #dedbe1;
    cursor: pointer;
    border: none;
    padding: 0;
    transition: all 0.3s ease;
  }

  .carousel-dot:hover {
    background-color: #b8b3bd;
  }

  .carousel-dot.active {
    background-color: {{ section.settings.button_color }};
    width: 30px;
    border-radius: 5px;
  }

  /* ============================================
     Responsive Styles
     ============================================ */

  /* Tablet */
  @media (max-width: 968px) {
    .verified-review-section {
      padding: 50px 15px;
    }

    .verified-header {
      margin-bottom: 40px;
    }

    .testimonials-track {
      gap: 15px;
    }

    .testimonial-card {
      flex: 0 0 calc((100% - 15px) / 2);
      min-width: 250px;
    }

    .testimonial-card img {
      height: 280px;
    }
  }

  /* Mobile */
  @media (max-width: 640px) {
    .verified-review-section {
      padding: 40px 15px;
    }

    .verified-title {
      font-size: 28px;
    }

    .verified-subtitle {
      font-size: 16px;
    }

    .verified-header {
      margin-bottom: 30px;
    }
    
    .testimonials-carousel {
      margin-bottom: 30px;
      padding: 15px 0;
    }
    
    .testimonials-track {
      gap: 12px;
    }
    
    .testimonial-card {
      flex: 0 0 calc(100% - 40px);
      min-width: unset;
      max-width: 100%;
      padding: 16px 20px;
    }

    .testimonial-card img {
      height: 300px;
    }
    
    .testimonial-title {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .testimonial-content {
      font-size: 14px;
      line-height: 1.5;
    }

    .author-name {
      font-size: 16px;
    }
    
    .carousel-controls {
      gap: 10px;
    }
    
    .carousel-button {
      width: 38px;
      height: 38px;
    }
    
    .carousel-button svg {
      width: 16px;
      height: 16px;
    }

    .carousel-dot {
      width: 8px;
      height: 8px;
    }

    .carousel-dot.active {
      width: 24px;
    }
  }

  /* Small Mobile */
  @media (max-width: 480px) {
    .verified-title {
      font-size: 24px;
    }

    .testimonial-card {
      flex: 0 0 calc(100% - 30px);
    }
  }
{% endstyle %}

<script>
  (function() {
    const sectionId = '{{ section.id }}';
    const track = document.getElementById('testimonials-track-' + sectionId);
    const prevBtn = document.getElementById('prev-btn-' + sectionId);
    const nextBtn = document.getElementById('next-btn-' + sectionId);
    const dotsContainer = document.getElementById('carousel-dots-' + sectionId);
    
    if (!track || !prevBtn || !nextBtn || !dotsContainer) {
      console.error('Testimonials carousel elements not found for section:', sectionId);
      return;
    }
    
    const originalCards = Array.from(track.querySelectorAll('.testimonial-card'));
    
    if (originalCards.length === 0) {
      return;
    }

    // Get cards per view based on screen size
    function getCardsPerView() {
      if (window.innerWidth <= 640) return 1;
      if (window.innerWidth <= 968) return 2;
      return 3;
    }

    const totalCards = originalCards.length;
    const cardsPerView = getCardsPerView();

    // Hide controls if cards fit in view
    if (totalCards <= cardsPerView) {
      prevBtn.style.display = 'none';
      nextBtn.style.display = 'none';
      dotsContainer.style.display = 'none';
      return;
    }
    
    let currentIndex = 0;
    let isTransitioning = false;
    
    // Clone cards for infinite effect
    function setupInfiniteCarousel() {
      originalCards.forEach(card => {
        const clone = card.cloneNode(true);
        track.appendChild(clone);
      });
      
      for (let i = originalCards.length - 1; i >= 0; i--) {
        const clone = originalCards[i].cloneNode(true);
        track.insertBefore(clone, track.firstChild);
      }
      
      currentIndex = totalCards;
      updateCarousel(false);
    }

    function createDots() {
      dotsContainer.innerHTML = '';
      for (let i = 0; i < totalCards; i++) {
        const dot = document.createElement('button');
        dot.classList.add('carousel-dot');
        dot.setAttribute('aria-label', `Go to slide ${i + 1}`);
        if (i === 0) dot.classList.add('active');
        dot.addEventListener('click', () => goToSlide(i));
        dotsContainer.appendChild(dot);
      }
    }

    function updateCarousel(animate = true) {
      const allCards = track.querySelectorAll('.testimonial-card');
      const cardWidth = allCards[0].offsetWidth;
      const style = window.getComputedStyle(track);
      const gap = parseInt(style.gap || 20);
      
      let offset = currentIndex * (cardWidth + gap);
      
      // Center card on mobile
      if (window.innerWidth <= 640) {
        const carouselWidth = track.parentElement.offsetWidth;
        const centerOffset = (carouselWidth - cardWidth) / 2;
        offset = offset - centerOffset;
      }

      track.style.transition = animate ? 'transform 0.5s ease' : 'none';
      track.style.transform = `translateX(-${offset}px)`;
      
      if (!animate) {
        track.offsetHeight; // Force reflow
        track.style.transition = 'transform 0.5s ease';
      }

      updateDots();
      updateActiveCard();
    }

    function updateDots() {
      const dots = dotsContainer.querySelectorAll('.carousel-dot');
      const actualIndex = ((currentIndex - totalCards) % totalCards + totalCards) % totalCards;
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === actualIndex);
      });
    }

    function updateActiveCard() {
      const allCards = track.querySelectorAll('.testimonial-card');
      const windowWidth = window.innerWidth;
      
      let activeCardIndex;
      if (windowWidth <= 640) {
        activeCardIndex = currentIndex;
      } else if (windowWidth <= 968) {
        activeCardIndex = currentIndex;
      } else {
        activeCardIndex = currentIndex + 1;
      }
      
      allCards.forEach((card, index) => {
        card.classList.toggle('active', index === activeCardIndex);
      });
    }

    function goToSlide(slideIndex) {
      if (isTransitioning) return;
      currentIndex = totalCards + slideIndex;
      updateCarousel();
    }

    function handleTransitionEnd() {
      isTransitioning = false;
      
      if (currentIndex >= totalCards * 2) {
        currentIndex = totalCards;
        updateCarousel(false);
      }
      
      if (currentIndex < totalCards) {
        currentIndex = totalCards * 2 - 1;
        updateCarousel(false);
      }
    }

    prevBtn.addEventListener('click', () => {
      if (isTransitioning) return;
      isTransitioning = true;
      currentIndex--;
      updateCarousel();
    });

    nextBtn.addEventListener('click', () => {
      if (isTransitioning) return;
      isTransitioning = true;
      currentIndex++;
      updateCarousel();
    });

    track.addEventListener('transitionend', handleTransitionEnd);

    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        updateCarousel(false);
      }, 250);
    });

    setupInfiniteCarousel();
    createDots();
  })();
</script>

{% schema %}
{
  "name": "Verified Reviews Carousel",
  "settings": [
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "What Our Customers Say"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title Color",
      "default": "#605471"
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 20,
      "max": 80,
      "step": 2,
      "unit": "px",
      "label": "Title Size",
      "default": 40
    },
    {
      "type": "text",
      "id": "section_subtitle",
      "label": "Section Subtitle",
      "default": "Verified Customer Reviews"
    },
    {
      "type": "color",
      "id": "subtitle_color",
      "label": "Subtitle Color",
      "default": "#656565"
    },
    {
      "type": "range",
      "id": "subtitle_size",
      "min": 14,
      "max": 40,
      "step": 1,
      "unit": "px",
      "label": "Subtitle Size",
      "default": 20
    },
    {
      "type": "color",
      "id": "section_background",
      "label": "Section Background Color",
      "default": "#f7f9fd"
    },
    {
      "type": "header",
      "content": "Reviews Source"
    },
    {
      "type": "metaobject",
      "id": "featured_item",
      "label": "Select Metaobject",
      "metaobject_type": "testimonials"
    },
    {
      "type": "header",
      "content": "Carousel Styling"
    },
    {
      "type": "color",
      "id": "card_color",
      "label": "Testimonial Card Color",
      "default": "#FCFAFF"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Navigation Button Color",
      "default": "#605471"
    },
    {
      "type": "checkbox",
      "id": "card_zoom",
      "label": "Active Card Zoom Effect",
      "default": true
    },
    {
      "type": "color",
      "id": "card_active_color",
      "label": "Active Card Color",
      "default": "#e6e1ec"
    },
    {
      "type": "header",
      "content": "Card Content Styling"
    },
    {
      "type": "color",
      "id": "testimonial_star_color",
      "label": "Star Color",
      "default": "#ffa500"
    },
    {
      "type": "color",
      "id": "testimonial_author_color",
      "label": "Name Color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "testimonial_author_size",
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Name Size",
      "default": 18
    },
    {
      "type": "color",
      "id": "badge_color",
      "label": "Badge Color",
      "default": "#605471"
    },
    {
      "type": "color",
      "id": "testimonial_title_color",
      "label": "Heading Color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "testimonial_title_size",
      "min": 14,
      "max": 24,
      "step": 1,
      "unit": "px",
      "label": "Heading Size",
      "default": 18
    },
    {
      "type": "color",
      "id": "testimonial_content_color",
      "label": "Content Color",
      "default": "#656565"
    },
    {
      "type": "range",
      "id": "testimonial_content_size",
      "min": 12,
      "max": 18,
      "step": 1,
      "unit": "px",
      "label": "Content Size",
      "default": 16
    }
  ],
  "presets": [
    {
      "name": "Verified Reviews Carousel"
    }
  ]
}
{% endschema %}
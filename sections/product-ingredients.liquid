{% liquid
  assign section_id = 'product-ingredients-' | append: section.id
  
  # Count ingredients per column
  assign left_count = 0
  assign right_count = 0
  for block in section.blocks
    if block.settings.column_position == 'left'
      assign left_count = left_count | plus: 1
    elsif block.settings.column_position == 'right'
      assign right_count = right_count | plus: 1
    endif
  endfor
%}

<div class="product-ingredients-section {{ section_id }}">
  <div class="container">
    <div class="vwcm-container">
      
      {%- comment -%} Editor Warning {%- endcomment -%}
      {%- if request.design_mode -%}
        {%- if left_count > 5 or right_count > 5 -%}
          <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 16px; margin-bottom: 24px; text-align: left;">
            <strong style="color: #856404;">⚠️ Ingredient Limit Exceeded</strong>
            <p style="color: #856404; margin: 8px 0 0 0; font-size: 14px;">
              {%- if left_count > 5 -%}
                Left column: {{ left_count }} ingredients (max 5). Only the first 5 will display.<br>
              {%- endif -%}
              {%- if right_count > 5 -%}
                Right column: {{ right_count }} ingredients (max 5). Only the first 5 will display.
              {%- endif -%}
            </p>
          </div>
        {%- endif -%}
      {%- endif -%}
      
      {%- comment -%} Section Title {%- endcomment -%}
      {%- if section.settings.section_title != blank -%}
        <h1 class="pdp-section-title vwcm-title">
          {{ section.settings.section_title }}
        </h1>
      {%- endif -%}
      
      <div class="vwcm-grid">
        
        {%- comment -%} LEFT COLUMN {%- endcomment -%}
        <div class="vwcm-col first">
          {%- assign left_item_count = 0 -%}
          {%- for block in section.blocks -%}
            {%- if block.settings.column_position == 'left' -%}
              {%- assign left_item_count = left_item_count | plus: 1 -%}
              {%- if left_item_count <= 5 -%}
                <div class="vwcm-item" {{ block.shopify_attributes }}>
                  <div class="dot">
                    {%- if block.settings.ingredient_icon != blank -%}
                      <img 
                        src="{{ block.settings.ingredient_icon | image_url: width: 72 }}" 
                        alt="{{ block.settings.ingredient_title }}" 
                        class="ingredient-icon"
                        loading="lazy"
                        width="36"
                        height="36"
                      >
                    {%- endif -%}
                  </div>
                  <h3>{{ block.settings.ingredient_title }}</h3>
                  <p>{{ block.settings.ingredient_text }}</p>
                </div>
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
        </div>

        {%- comment -%} CENTER IMAGE {%- endcomment -%}
        <div class="vwcm-center">
          <div class="center-bg"></div>
          {% if block.settings.image %}
              <img
                src="{{ block.settings.image | image_url: width: 1000 }}"
                alt="{{ block.settings.customer_name | default: 'Customer' }}"
                loading="lazy"
                style="object-position: {{ block.settings.position }};"
              >
            {% else %}
              <img
                src="{{ 'placeholder.webp' | asset_url }}"
                alt="{{ block.settings.customer_name | default: 'Customer' }}"
                loading="lazy"
              >
            {% endif %}
        </div>

        {%- comment -%} RIGHT COLUMN {%- endcomment -%}
        <div class="vwcm-col second">
          {%- assign right_item_count = 0 -%}
          {%- for block in section.blocks -%}
            {%- if block.settings.column_position == 'right' -%}
              {%- assign right_item_count = right_item_count | plus: 1 -%}
              {%- if right_item_count <= 5 -%}
                <div class="vwcm-item" {{ block.shopify_attributes }}>
                  <div class="dot">
                    {%- if block.settings.ingredient_icon != blank -%}
                      <img 
                        src="{{ block.settings.ingredient_icon | image_url: width: 72 }}" 
                        alt="{{ block.settings.ingredient_title }}" 
                        class="ingredient-icon"
                        loading="lazy"
                        width="36"
                        height="36"
                      >
                    {%- endif -%}
                  </div>
                  <h3>{{ block.settings.ingredient_title }}</h3>
                  <p>{{ block.settings.ingredient_text }}</p>
                </div>
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
        </div>
      </div>

      {%- comment -%} All Ingredients Dropdown {%- endcomment -%}
      {%- if section.settings.all_ingredients != blank -%}
        <div class="all-ingredients">
          <div class="drop-header">
            <span>All Ingredients</span>
            <span class="chevron">
              <img 
                src="{{ 'arrow.webp' | asset_url }}" 
                alt="Toggle ingredients"
                class="chevron-icon"
                width="14"
                height="14"
              >
            </span>
          </div>
          <div class="drop-content">
            {{ section.settings.all_ingredients }}
          </div>
        </div>
      {%- endif -%}
      
    </div>
  </div>
</div>

{% style %}
/* ========================================
   CONTAINER & LAYOUT
   ======================================== */
.{{ section_id }} .vwcm-container {
  max-width: 1100px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 32px;
  text-align: center;
  font-family: "Inter", sans-serif;
}

.{{ section_id }} .vwcm-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 40px;
  align-items: center;
  width: 100%;
}

/* ========================================
   INGREDIENT COLUMNS
   ======================================== */
.{{ section_id }} .vwcm-col {
  display: flex;
  flex-direction: column;
  gap: 50px;
  height: 100%;
  justify-content: space-between;
}

.{{ section_id }} .vwcm-item {
  position: relative;
  display: flex;
  flex-direction: column;
  text-align: left;
}

.{{ section_id }} .vwcm-col .vwcm-item .dot {
  width: 36px;
  margin-bottom: 12px;
}

.{{ section_id }} .ingredient-icon {
  display: block;
  width: 100%;
  height: auto;
}

/* Left Column Alignment */
.{{ section_id }} .vwcm-col.first .vwcm-item {
  align-items: end;
  text-align: end;
}

/* Dynamic Middle Item Padding - Left Column */
/* 3 items: middle item (2nd) gets padding */
.{{ section_id }} .vwcm-col.first .vwcm-item:nth-child(2):nth-last-child(2) {
  padding-right: 40px;
}

/* 4 items: 2nd and 3rd items get padding */
.{{ section_id }} .vwcm-col.first .vwcm-item:nth-child(2):nth-last-child(3),
.{{ section_id }} .vwcm-col.first .vwcm-item:nth-child(3):nth-last-child(2) {
  padding-right: 40px;
}

/* 5 items: 2nd, 3rd, and 4th items get padding */
.{{ section_id }} .vwcm-col.first .vwcm-item:nth-child(2):nth-last-child(4),
.{{ section_id }} .vwcm-col.first .vwcm-item:nth-child(3):nth-last-child(3),
.{{ section_id }} .vwcm-col.first .vwcm-item:nth-child(4):nth-last-child(2) {
  padding-right: 40px;
}

/* 6 items: 2nd, 3rd, 4th, and 5th items get padding */
.{{ section_id }} .vwcm-col.first .vwcm-item:nth-child(2):nth-last-child(5),
.{{ section_id }} .vwcm-col.first .vwcm-item:nth-child(3):nth-last-child(4),
.{{ section_id }} .vwcm-col.first .vwcm-item:nth-child(4):nth-last-child(3),
.{{ section_id }} .vwcm-col.first .vwcm-item:nth-child(5):nth-last-child(2) {
  padding-right: 40px;
}

/* Right Column Alignment */
/* Dynamic Middle Item Padding - Right Column */
/* 3 items: middle item (2nd) gets padding */
.{{ section_id }} .vwcm-col.second .vwcm-item:nth-child(2):nth-last-child(2) {
  padding-left: 40px;
}

/* 4 items: 2nd and 3rd items get padding */
.{{ section_id }} .vwcm-col.second .vwcm-item:nth-child(2):nth-last-child(3),
.{{ section_id }} .vwcm-col.second .vwcm-item:nth-child(3):nth-last-child(2) {
  padding-left: 40px;
}

/* 5 items: 2nd, 3rd, and 4th items get padding */
.{{ section_id }} .vwcm-col.second .vwcm-item:nth-child(2):nth-last-child(4),
.{{ section_id }} .vwcm-col.second .vwcm-item:nth-child(3):nth-last-child(3),
.{{ section_id }} .vwcm-col.second .vwcm-item:nth-child(4):nth-last-child(2) {
  padding-left: 40px;
}

/* 6 items: 2nd, 3rd, 4th, and 5th items get padding */
.{{ section_id }} .vwcm-col.second .vwcm-item:nth-child(2):nth-last-child(5),
.{{ section_id }} .vwcm-col.second .vwcm-item:nth-child(3):nth-last-child(4),
.{{ section_id }} .vwcm-col.second .vwcm-item:nth-child(4):nth-last-child(3),
.{{ section_id }} .vwcm-col.second .vwcm-item:nth-child(5):nth-last-child(2) {
  padding-left: 40px;
}

/* Typography */
.{{ section_id }} .vwcm-item h3 {
  font-size: 24px;
  margin-bottom: 8px;
}

.{{ section_id }} .vwcm-item p {
  font-size: 14px;
  line-height: 1.5;
  color: #746c8a;
  margin: 0;
}

/* ========================================
   CENTER IMAGE
   ======================================== */
.{{ section_id }} .vwcm-center {
  position: relative;
  text-align: center;
}

.{{ section_id }} .center-bg {
  width: 400px;
  height: 400px;
  background: linear-gradient(90deg, #B9B2E1 0%, #F7F6FF 100%);
  border-radius: 50%;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

.{{ section_id }} .mask-img {
  position: relative;
  width: 100%;
  max-width: 400px;
  height: auto;
  z-index: 2;
}

/* ========================================
   INGREDIENTS DROPDOWN
   ======================================== */
.{{ section_id }} .all-ingredients {
  max-width: 839px;
  width: 100%;
  padding: 0;
  background: #FDFDFD;
  border-radius: 14px;
  overflow: hidden;
  text-align: left;
}

.{{ section_id }} .drop-header {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  padding: 18px 24px;
  font-size: 24px;
  color: #4d4563;
  cursor: pointer;
  user-select: none;
}

.{{ section_id }} .chevron {
  display: inline-flex;
  align-items: center;
}

.{{ section_id }} .chevron-icon {
  width: 14px;
  height: auto;
  transition: transform 0.3s ease;
}

.{{ section_id }} .all-ingredients.open .chevron-icon {
  transform: rotate(180deg);
}

.{{ section_id }} .drop-content {
  display: none;
  padding: 0 24px 20px;
  font-size: 14px;
  line-height: 1.6;
  color: #6b657c;
  text-align: center;
}

.{{ section_id }} .all-ingredients.open .drop-content {
  display: block;
  font-family: 'Chivo Mono', monospace;
}

/* ========================================
   MOBILE RESPONSIVENESS
   ======================================== */
@media (max-width: 768px) {
  .{{ section_id }} .vwcm-container {
    padding: 40px 20px;
  }

  .{{ section_id }} .vwcm-title {
    font-size: 26px;
    margin-bottom: 40px;
  }

  .{{ section_id }} .vwcm-grid {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  /* Reorder Grid Items */
  .{{ section_id }} .vwcm-center {
    order: 1;
  }

  .{{ section_id }} .vwcm-col.first {
    order: 2;
  }

  .{{ section_id }} .vwcm-col.second {
    order: 3;
  }

  /* Reset Column Styling */
  .{{ section_id }} .vwcm-col.first,
  .{{ section_id }} .vwcm-col.second {
    align-items: flex-start;
    text-align: left;
    gap: 16px;
  }

  /* Mobile Ingredient Cards */
  .{{ section_id }} .vwcm-item {
    flex-direction: column;
    gap: 8px;
    align-items: center;
    justify-content: center;
    padding: 12px 32px;
    background-color: #FDFDFD;
    border-radius: 12px;
    text-align: center;
  }

  /* Reset all dynamic padding on mobile */
  .{{ section_id }} .vwcm-col.first .vwcm-item,
  .{{ section_id }} .vwcm-col.second .vwcm-item {
    padding: 12px 32px !important;
  }

  .{{ section_id }} .vwcm-item h3 {
    margin: 0;
    text-align: center;
  }

  .{{ section_id }} .vwcm-item p {
    margin-top: 2px;
    text-align: center;
  }

  /* Center Image Resize */
  .{{ section_id }} .center-bg {
    width: 389px;
    height: 389px;
  }

  .{{ section_id }} .mask-img {
    max-width: 210px;
  }

  /* Dropdown Spacing */
  .{{ section_id }} .all-ingredients {
    margin-top: 40px;
  }

  .{{ section_id }} .drop-content {
    text-align: left;
  }
}

/* Extra Small Screens */
@media (max-width: 480px) {
  .{{ section_id }} .vwcm-title {
    font-size: 22px;
  }

  .{{ section_id }} .center-bg {
    width: 290px;
    height: 290px;
  }
}
{% endstyle %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const ingredientsBlock = document.querySelector('.{{ section_id }} .all-ingredients');
    
    if (ingredientsBlock) {
      const header = ingredientsBlock.querySelector('.drop-header');
      
      header.addEventListener('click', function() {
        ingredientsBlock.classList.toggle('open');
      });
    }
  });
</script>

{% schema %}
{
  "name": "Product Ingredients",
  "max_blocks": 10,
  "settings": [
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "Product Ingredients"
    },
    {
      "type": "image_picker",
      "id": "center_image",
      "label": "Center Image"
    },
    {
      "type": "richtext",
      "id": "all_ingredients",
      "label": "All Ingredients List",
      "info": "Full ingredient list shown in dropdown"
    }
  ],
  "blocks": [
    {
      "type": "ingredient",
      "name": "Ingredient",
      "limit": 10,
      "settings": [
        {
          "type": "select",
          "id": "column_position",
          "label": "Column Position",
          "options": [
            {
              "value": "left",
              "label": "Left"
            },
            {
              "value": "right",
              "label": "Right"
            }
          ],
          "default": "left",
          "info": "Maximum 5 ingredients per column recommended"
        },
        {
          "type": "image_picker",
          "id": "ingredient_icon",
          "label": "Ingredient Icon"
        },
        {
          "type": "text",
          "id": "ingredient_title",
          "label": "Ingredient Title",
          "default": "Ingredient Name"
        },
        {
          "type": "textarea",
          "id": "ingredient_text",
          "label": "Ingredient Description",
          "default": "Brief description of this ingredient and its benefits."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Ingredients",
      "blocks": [
        {
          "type": "ingredient",
          "settings": {
            "column_position": "left",
            "ingredient_title": "Vitamin C",
            "ingredient_text": "Brightens and evens skin tone"
          }
        },
        {
          "type": "ingredient",
          "settings": {
            "column_position": "left",
            "ingredient_title": "Hyaluronic Acid",
            "ingredient_text": "Deep hydration and plumping"
          }
        },
        {
          "type": "ingredient",
          "settings": {
            "column_position": "left",
            "ingredient_title": "Niacinamide",
            "ingredient_text": "Minimizes pores and refines texture"
          }
        },
        {
          "type": "ingredient",
          "settings": {
            "column_position": "right",
            "ingredient_title": "Retinol",
            "ingredient_text": "Reduces fine lines and wrinkles"
          }
        },
        {
          "type": "ingredient",
          "settings": {
            "column_position": "right",
            "ingredient_title": "Peptides",
            "ingredient_text": "Boosts collagen production"
          }
        },
        {
          "type": "ingredient",
          "settings": {
            "column_position": "right",
            "ingredient_title": "Green Tea Extract",
            "ingredient_text": "Antioxidant protection"
          }
        }
      ]
    }
  ]
}
{% endschema %}

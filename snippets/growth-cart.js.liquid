{%- comment %}
  @param cart (cart, mandatory)
  @param checkout_url (string, mandatory) the checkout url
  @param checkout_button_selector (string) the query selector for the checkout button
{% endcomment -%}

{% unless checkout_url %}
  {% assign checkout_url = 'https://ck.evolenne.com/checkout' %}
{% endunless %}

{% unless checkout_button_selector %}
  {% assign checkout_button_selector = '[type="submit"][name="checkout"]' %}
{% endunless %}
<script>
  document.addEventListener("DOMContentLoaded", function () {

    var debug = true ? console.log.bind(console, '[DEBUG][RedirectCart]') : function () {};

    debug('Script loaded');

    window.RedirectCart = function (options) {


      var self = {};


     function productIdsWithQuantities() {
    {%- assign added_first = false -%}
    return {
      {%- for item in cart.items -%}
        {%- assign property_size = item.properties | size -%}
        {% if property_size > 0 %}
          {%- capture prdctOptions -%}
            {% for p in item.properties %}
              {% unless p.last == blank %}{{ p.first }}~{% if p.last contains '/uploads/' %}{{ p.last | split: '/' | last }}{% else %}{{ p.last }}{% endif %}{% unless forloop.last %}|{% endunless -%}
              {% endunless %}
            {% endfor %}
          {%- endcapture %}
          {%- assign prdctOptionForUrl = prdctOptions | newline_to_br | split: '<br />' -%}
          {%- capture stripedPrdctOptions -%}
            {% for pOption in prdctOptionForUrl -%}
                {{ pOption | strip | strip_newlines | url_encode  }}
            {%- endfor %}
          {%- endcapture %}
        {% endif %} 
        {%- if item.variant.metafields.productId.productId -%}
      {%- if added_first %},{% endif -%}
        {%- if item.selling_plan_allocation -%}
          {% if property_size > 0 %}
            "{{ item.variant.metafields.productId.productId}}{{"|"}}{{item.selling_plan_allocation.selling_plan.name | url_encode}}{{ "|" }}{{ stripedPrdctOptions | strip_newlines }}": {{ item.quantity | json }}
          {% else %}
            "{{ item.variant.metafields.productId.productId}}{{"|"}}{{item.selling_plan_allocation.selling_plan.name | url_encode}}": {{ item.quantity | json }}
          {% endif %}
      {%- else -%}
          {% if property_size > 0 %}
            "{{ item.variant.metafields.productId.productId }}{{ "|" }}{{ "|" }}{{ stripedPrdctOptions | strip_newlines }}": {{ item.quantity | json }}
          {% else %}
            "{{ item.variant.metafields.productId.productId }}": {{ item.quantity | json }}
          {% endif %}
      {% endif -%}
          {%- assign added_first = true -%}
        
      {%- endif -%}
      
      {%- endfor -%}
    };
  }


      function init() {
        self.options = Object.assign({
          products: productIdsWithQuantities(),
          checkoutButtonSelector: '{{ checkout_button_selector }}',
          checkoutUrl: '{{ checkout_url }}',
        }, options);

        self.$checkoutButton = $(self.options.checkoutButtonSelector);

        debug('Initialized with options', self.options);
        
        inject();
      }


      function inject() {
        debug('Inject');
        self.$checkoutButton.on('click', checkout);
      }


      function checkout(event) {
        var checkoutUrl = getCheckoutURL(self.options.products);
        debug('Checkout ->', checkoutUrl);
        event.preventDefault();
        window.location.href = checkoutUrl;
      }
      
      function getCartCookie(name) {
       var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        if (match){ 
          return match[2];
          }
 	  }

      function getCheckoutURL(products) {
        const cookie = getCartCookie('cart');
        const urlLineItems = Object.keys(products).reduce(function (output, productId) {
          const quantity = products[productId];
          return output.concat([productId + ':' + quantity]);
        }, []).join(';');
      
        const shopliftTest = localStorage.getItem('shoplift_test');

        if (shopliftTest) {
          const parsedData = JSON.parse(shopliftTest);
          const now = new Date().getTime();
        
          if (now <= parsedData.expiry) {
            const testValue = parsedData.value === 'true' ? 'true' : 'false';
            return self.options.checkoutUrl + '?products=' + urlLineItems + '&cartId=' + cookie + '&shoplift_test=' + testValue;
          } else {
            localStorage.removeItem('shoplift_test');
          }
        }

      
        return self.options.checkoutUrl + '?products=' + urlLineItems + '&cartId=' + cookie;
      }



      init();

      return self;

    };

    var instance = new RedirectCart();

  });

</script>